<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kontext Lab</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #1a1a1a;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        .dot-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle, #404040 1px, transparent 1px);
            background-size: 30px 30px;
            background-position: 15px 15px;
            opacity: 0.6;
        }

        /* Additional dot layer for denser grid effect */
        .dot-grid::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle, #2a2a2a 0.5px, transparent 0.5px);
            background-size: 15px 15px;
            background-position: 7.5px 7.5px;
            opacity: 0.3;
        }

        /* Subtle animation for organic feel */
        .dot-grid {
            animation: subtleShift 20s ease-in-out infinite;
        }

        @keyframes subtleShift {
            0%, 100% {
                transform: translate(0, 0); 
            }
            25% { 
            transform: translate(1px, 1px);
            }
            50% { 
                transform: translate(0, 2px); 
            }
            75% { 
                transform: translate(-1px, 1px); 
            }
        }

        /* Optional: Add a subtle vignette effect */
        .vignette {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.3) 100%);
            pointer-events: none;
        }

        /* Canvas container that can be transformed */
        .canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        /* Card styling */
        .image-card {
            position: absolute;
            width: 400px;
            height: 500px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 20;
        }

        /* Center the first card - focused state */
        .image-card.center {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(1);
            filter: blur(0px);
            z-index: 30;
        }

        /* Side cards - partially visible and blurred */
        .image-card.side-left {
            top: 50%;
            left: 20%;
            transform: translate(-50%, -50%) scale(0.7);
            filter: blur(2px);
            opacity: 0.85;
            z-index: 25;
        }

        .image-card.side-right {
            top: 50%;
            left: 80%;
            transform: translate(-50%, -50%) scale(0.7);
            filter: blur(2px);
            opacity: 0.85;
            z-index: 25;
        }

        /* Top and bottom cards - more distant */
        .image-card.side-top {
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.6);
            filter: blur(3px);
            opacity: 0.75;
            z-index: 25;
        }

        .image-card.side-bottom {
            top: 75%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.6);
            filter: blur(3px);
            opacity: 0.75;
            z-index: 25;
        }

        /* Off-screen cards - very small and blurred */
        .image-card.off-screen {
            transform: translate(-50%, -50%) scale(0.4);
            filter: blur(5px);
            opacity: 0.2;
            z-index: 15;
        }

        .image-container {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .image-container::before {
            content: 'üñºÔ∏è';
            font-size: 48px;
            opacity: 0.5;
            margin-bottom: 8px;
        }

        .image-placeholder {
            text-align: center;
            line-height: 1.5;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: #212529;
            text-align: center;
            margin: 0;
        }

        /* Card metadata styling */
        .card-metadata {
            margin-top: 12px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 6px;
            font-size: 11px;
            color: #666;
            line-height: 1.3;
        }

        .metadata-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .metadata-row:last-child {
            margin-bottom: 0;
        }

        .metadata-label {
            font-weight: 600;
            color: #444;
        }

        .metadata-value {
            text-align: right;
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Hide metadata in grid view */
        .image-card.grid-view .card-metadata {
            display: none;
        }

        /* Attributes Panel */
        .attributes-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 100;
            font-size: 12px;
            transition: opacity 0.3s ease;
        }

        .attributes-panel.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .panel-title {
            font-size: 14px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 12px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding-bottom: 8px;
        }

        .panel-row {
            display: flex;
            margin-bottom: 8px;
            align-items: flex-start;
        }

        .panel-row:last-child {
            margin-bottom: 0;
        }

        .panel-label {
            font-weight: 600;
            color: #444;
            min-width: 60px;
            margin-right: 8px;
        }

        .panel-value {
            color: #666;
            line-height: 1.4;
            word-wrap: break-word;
            flex: 1;
        }

        /* Arrow base styling */
        .arrow {
            position: absolute;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 50;
        }

        .arrow svg {
            width: 24px;
            height: 24px;
        }

        /* Arrow positions */
        .arrow-top {
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
        }

        .arrow-bottom {
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
        }

        .arrow-left {
            left: 40px;
            top: 50%;
            transform: translateY(-50%);
        }

        .arrow-right {
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Zoom button styling */
        .zoom-button {
            position: absolute;
            top: 40px;
            right: 40px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 50;
            transition: all 0.3s ease;
        }

        .zoom-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .zoom-button svg {
            width: 20px;
            height: 20px;
        }

        /* Zoomed out state */
        body.zoomed-out .arrow {
            display: none;
        }

        body.zoomed-out .canvas-container {
            cursor: grab;
            transition: none;
        }

        body.zoomed-out .canvas-container.dragging {
            cursor: grabbing;
        }

        /* Grid view card styling */
        .image-card.grid-view {
            width: 150px;
            height: 180px;
            padding: 10px;
            position: absolute;
            transform: translate(-50%, -50%);
            filter: none;
            opacity: 1;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .image-card.grid-view:hover {
            transform: translate(-50%, -50%) scale(1.1);
            z-index: 40;
        }

        .image-card.grid-view .image-container {
            margin-bottom: 8px;
        }

        .image-card.grid-view .image-container::before {
            font-size: 24px;
        }

        .image-card.grid-view .card-title {
            font-size: 12px;
        }

        .image-card.grid-view .image-placeholder {
            font-size: 10px;
        }

        .image-card.grid-view .image-placeholder div:first-child {
            font-size: 32px !important;
            margin-bottom: 4px !important;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .image-card {
                width: 90vw;
                max-width: 350px;
                height: 450px;
                padding: 16px;
            }
            
            .image-container::before {
                font-size: 36px;
            }
            
            .card-title {
                font-size: 18px;
            }

            .arrow svg {
                width: 20px;
                height: 20px;
            }

            .arrow-top, .arrow-bottom {
                top: 20px;
            }

            .arrow-bottom {
                bottom: 20px;
                top: auto;
            }

            .arrow-left, .arrow-right {
                left: 20px;
            }

            .arrow-right {
                right: 20px;
                left: auto;
            }

            .zoom-button {
                top: 20px;
                right: 20px;
                width: 36px;
                height: 36px;
            }

            .zoom-button svg {
                width: 18px;
                height: 18px;
            }

            .image-card.grid-view {
                width: 100px;
                height: 120px;
                padding: 8px;
            }

            .image-card.grid-view .image-placeholder div:first-child {
                font-size: 24px !important;
            }

            .image-card.grid-view .card-title {
                font-size: 10px;
            }

            .attributes-panel {
                width: 260px;
                bottom: 10px;
                left: 10px;
                padding: 12px;
                font-size: 11px;
            }

            .panel-title {
                font-size: 13px;
                margin-bottom: 10px;
            }

            .panel-label {
                min-width: 50px;
            }
        }
    </style>
</head>
<body>
    <div class="dot-grid"></div>
    <div class="vignette"></div>
    
    <!-- Top Arrow -->
    <div class="arrow arrow-top" onclick="moveCanvas('up')">
        <svg viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 19V5M5 12l7-7 7 7"/>
        </svg>
    </div>

    <!-- Bottom Arrow -->
    <div class="arrow arrow-bottom" onclick="moveCanvas('down')">
        <svg viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 5v14M19 12l-7 7-7-7"/>
        </svg>
    </div>

    <!-- Left Arrow -->
    <div class="arrow arrow-left" onclick="moveCanvas('left')">
        <svg viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
    </div>

    <!-- Right Arrow -->
    <div class="arrow arrow-right" onclick="moveCanvas('right')">
        <svg viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <path d="M5 12h14M12 5l7 7-7 7"/>
        </svg>
    </div>
    
    <!-- Zoom Button -->
    <div class="zoom-button" onclick="toggleZoom()">
        <svg viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
            <line x1="8" y1="11" x2="14" y2="11"></line>
        </svg>
    </div>
    
    <!-- Canvas container that holds all cards -->
    <div class="canvas-container" id="canvasContainer">
        <div class="image-card center" id="card-0">
            <div class="image-container">
                <div class="image-placeholder">
                    Image will appear here
                </div>
            </div>
            <h3 class="card-title">Card 1</h3>
        </div>
    </div>

    <!-- Attributes Panel -->
    <div class="attributes-panel" id="attributesPanel">
        <div class="panel-title">Image Attributes</div>
        <div class="panel-row">
            <span class="panel-label">Style:</span>
            <span class="panel-value" id="panelStyle">-</span>
        </div>
        <div class="panel-row">
            <span class="panel-label">Quality:</span>
            <span class="panel-value" id="panelQuality">-</span>
        </div>
        <div class="panel-row">
            <span class="panel-label">Tags:</span>
            <span class="panel-value" id="panelTags">-</span>
        </div>
        <div class="panel-row">
            <span class="panel-label">Prompt:</span>
            <span class="panel-value" id="panelPrompt">-</span>
        </div>
    </div>

    <script>
        // Grid system - stores cards by their x,y coordinates
        const grid = new Map();
        
        // Card state management - stores metadata for each card
        const cardStates = new Map();
        
        let currentX = 0;
        let currentY = 0;
        let cardCount = 1;
        let isZoomedOut = false;
        let gridSpacing = 200; // Space between cards in grid view
        let canvasOffset = { x: 0, y: 0 };
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let dragOffset = { x: 0, y: 0 };
        let hasDraggedDistance = false;

        // Sample images and titles for variety
        const sampleData = [
            { 
                emoji: 'üåü', 
                title: 'Starlight', 
                text: 'A brilliant star',
                prompt: 'A brilliant star shining in the cosmic void with radiant beams of light',
                style: 'Cosmic/Space',
                tags: 'astronomy, light, celestial',
                quality: 'High'
            },
            { 
                emoji: 'üåä', 
                title: 'Ocean Wave', 
                text: 'Deep blue waters',
                prompt: 'Massive ocean wave crashing with white foam and deep blue waters',
                style: 'Nature/Seascape',
                tags: 'ocean, wave, blue, water',
                quality: 'High'
            },
            { 
                emoji: 'üî•', 
                title: 'Flame', 
                text: 'Burning bright',
                prompt: 'Intense orange and red flames dancing with sparks and heat distortion',
                style: 'Abstract/Fire',
                tags: 'fire, heat, orange, energy',
                quality: 'Medium'
            },
            { 
                emoji: 'üå∏', 
                title: 'Cherry Blossom', 
                text: 'Spring beauty',
                prompt: 'Delicate pink cherry blossoms on branches with soft sunlight filtering through',
                style: 'Nature/Botanical',
                tags: 'flowers, pink, spring, delicate',
                quality: 'High'
            },
            { 
                emoji: '‚ö°', 
                title: 'Lightning', 
                text: 'Electric energy',
                prompt: 'Dramatic lightning bolt cutting through dark storm clouds with electric glow',
                style: 'Weather/Storm',
                tags: 'lightning, storm, electric, dramatic',
                quality: 'Medium'
            },
            { 
                emoji: 'üåô', 
                title: 'Crescent Moon', 
                text: 'Night sky',
                prompt: 'Glowing crescent moon in a star-filled night sky with soft lunar light',
                style: 'Cosmic/Night',
                tags: 'moon, night, stars, glow',
                quality: 'High'
            },
            { 
                emoji: 'ü¶ã', 
                title: 'Butterfly', 
                text: 'Gentle wings',
                prompt: 'Colorful butterfly with intricate wing patterns resting on a flower',
                style: 'Nature/Wildlife',
                tags: 'butterfly, colorful, wings, nature',
                quality: 'High'
            },
            { 
                emoji: 'üé≠', 
                title: 'Theater Mask', 
                text: 'Drama and art',
                prompt: 'Ornate theater masks showing comedy and tragedy in golden tones',
                style: 'Art/Cultural',
                tags: 'theater, masks, drama, art',
                quality: 'Medium'
            },
            { 
                emoji: 'üîÆ', 
                title: 'Crystal Ball', 
                text: 'Mystical visions',
                prompt: 'Glowing crystal ball with swirling mystical energy and reflections',
                style: 'Fantasy/Mystical',
                tags: 'crystal, mystical, magic, glow',
                quality: 'High'
            },
            { 
                emoji: 'üé®', 
                title: 'Artist Palette', 
                text: 'Creative colors',
                prompt: 'Artist palette with vibrant paint colors mixing and blending together',
                style: 'Art/Creative',
                tags: 'art, paint, colors, creative',
                quality: 'Medium'
            }
        ];

        // Helper function to create grid key
        function gridKey(x, y) {
            return `${x},${y}`;
        }

        // Helper function to get card at position
        function getCardAt(x, y) {
            return grid.get(gridKey(x, y));
        }

        // Helper function to set card at position
        function setCardAt(x, y, card) {
            grid.set(gridKey(x, y), card);
        }

        // Helper function to get card state
        function getCardState(x, y) {
            return cardStates.get(gridKey(x, y));
        }

        // Helper function to set card state
        function setCardState(x, y, state) {
            cardStates.set(gridKey(x, y), state);
        }

        // Function to update attributes panel
        function updateAttributesPanel(x, y) {
            const state = getCardState(x, y);
            const panel = document.getElementById('attributesPanel');
            
            if (state) {
                document.getElementById('panelStyle').textContent = state.style;
                document.getElementById('panelQuality').textContent = state.quality;
                document.getElementById('panelTags').textContent = state.tags;
                document.getElementById('panelPrompt').textContent = state.prompt;
                panel.classList.remove('hidden');
            } else {
                panel.classList.add('hidden');
            }
        }

        function moveCanvas(direction) {
            // Calculate new position
            let newX = currentX;
            let newY = currentY;
            
            switch(direction) {
                case 'right':
                    newX = currentX + 1;
                    break;
                case 'left':
                    newX = currentX - 1;
                    break;
                case 'down':
                    newY = currentY + 1;
                    break;
                case 'up':
                    newY = currentY - 1;
                    break;
            }
            
            // Get or create card at new position
            let targetCard = getCardAt(newX, newY);
            
            if (!targetCard) {
                // Create new card at this position
                targetCard = createNewCard();
                setCardAt(newX, newY, targetCard);
                
                // Create and store card state
                const data = sampleData[cardCount % sampleData.length];
                const cardState = {
                    prompt: data.prompt,
                    style: data.style,
                    tags: data.tags,
                    quality: data.quality,
                    createdAt: new Date().toISOString(),
                    position: { x: newX, y: newY }
                };
                setCardState(newX, newY, cardState);
                
                // Add to DOM
                document.getElementById('canvasContainer').appendChild(targetCard);
            }
            
            // Update all visible cards
            updateVisibleCards(newX, newY);
            
            // Update current position
            currentX = newX;
            currentY = newY;
            
            // Update attributes panel for focused card
            updateAttributesPanel(newX, newY);
        }
        
        function updateVisibleCards(centerX, centerY) {
            // Hide all cards first and clean up grid view state
            grid.forEach((card) => {
                card.style.display = 'none';
                card.classList.remove('center', 'side-left', 'side-right', 'side-top', 'side-bottom', 'off-screen', 'grid-view');
                
                // Remove click handlers added in grid view
                card.onclick = null;
                
                // Remove hover handlers added in grid view
                card.onmouseenter = null;
                card.onmouseleave = null;
                
                // Clear absolute positioning from grid view
                card.style.left = '';
                card.style.top = '';
            });
            
            // Show and position center card
            const centerCard = getCardAt(centerX, centerY);
            if (centerCard) {
                centerCard.style.display = 'flex';
                centerCard.classList.add('center');
                centerCard.style.top = '50%';
                centerCard.style.left = '50%';
            }
            
            // Show and position adjacent cards
            const leftCard = getCardAt(centerX - 1, centerY);
            if (leftCard) {
                leftCard.style.display = 'flex';
                leftCard.classList.add('side-left');
                leftCard.style.top = '50%';
                leftCard.style.left = '20%';
            }
            
            const rightCard = getCardAt(centerX + 1, centerY);
            if (rightCard) {
                rightCard.style.display = 'flex';
                rightCard.classList.add('side-right');
                rightCard.style.top = '50%';
                rightCard.style.left = '80%';
            }
            
            const topCard = getCardAt(centerX, centerY - 1);
            if (topCard) {
                topCard.style.display = 'flex';
                topCard.classList.add('side-top');
                topCard.style.top = '25%';
                topCard.style.left = '50%';
            }
            
            const bottomCard = getCardAt(centerX, centerY + 1);
            if (bottomCard) {
                bottomCard.style.display = 'flex';
                bottomCard.classList.add('side-bottom');
                bottomCard.style.top = '75%';
                bottomCard.style.left = '50%';
            }
        }

        function createNewCard() {
            const newCard = document.createElement('div');
            const data = sampleData[cardCount % sampleData.length];
            
            newCard.className = 'image-card';
            newCard.id = `card-${cardCount}`;
            
            newCard.innerHTML = `
                <div class="image-container">
                    <div class="image-placeholder">
                        <div style="font-size: 64px; margin-bottom: 16px;">${data.emoji}</div>
                        <div>${data.text}</div>
                    </div>
                </div>
                <h3 class="card-title">${data.title}</h3>
            `;
            
            cardCount++;
            return newCard;
        }

        // Initialize with sample content for the first card
        function initializeFirstCard() {
            const firstCard = document.getElementById('card-0');
            const data = sampleData[0];
            
            firstCard.innerHTML = `
                <div class="image-container">
                    <div class="image-placeholder">
                        <div style="font-size: 64px; margin-bottom: 16px;">${data.emoji}</div>
                        <div>${data.text}</div>
                    </div>
                </div>
                <h3 class="card-title">${data.title}</h3>
            `;
            
            // Set the first card at origin (0,0)
            setCardAt(0, 0, firstCard);
            
            // Create and store initial card state
            const initialState = {
                prompt: data.prompt,
                style: data.style,
                tags: data.tags,
                quality: data.quality,
                createdAt: new Date().toISOString(),
                position: { x: 0, y: 0 }
            };
            setCardState(0, 0, initialState);
            
            // Show initial visible cards
            updateVisibleCards(0, 0);
            
            // Initialize attributes panel
            updateAttributesPanel(0, 0);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeFirstCard);

        // Zoom functionality
        function toggleZoom() {
            isZoomedOut = !isZoomedOut;
            const body = document.body;
            const canvasContainer = document.getElementById('canvasContainer');
            const zoomButton = document.querySelector('.zoom-button');
            
            if (isZoomedOut) {
                body.classList.add('zoomed-out');
                showGridView();
                
                // Change zoom icon to zoom in
                zoomButton.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                        <line x1="8" y1="11" x2="14" y2="11"></line>
                        <line x1="11" y1="8" x2="11" y2="14"></line>
                    </svg>
                `;
            } else {
                body.classList.remove('zoomed-out');
                
                // Reset canvas container state
                canvasContainer.style.transform = '';
                canvasContainer.classList.remove('dragging');
                canvasOffset = { x: 0, y: 0 };
                isDragging = false;
                
                // Restore normal view
                updateVisibleCards(currentX, currentY);
                
                // Update attributes panel for current card
                updateAttributesPanel(currentX, currentY);
                
                // Change zoom icon back to zoom out
                zoomButton.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                        <line x1="8" y1="11" x2="14" y2="11"></line>
                    </svg>
                `;
            }
        }

        function showGridView() {
            // Calculate grid bounds
            let minX = 0, maxX = 0, minY = 0, maxY = 0;
            
            grid.forEach((card, key) => {
                const [x, y] = key.split(',').map(Number);
                minX = Math.min(minX, x);
                maxX = Math.max(maxX, x);
                minY = Math.min(minY, y);
                maxY = Math.max(maxY, y);
            });
            
            // Adjust spacing for mobile
            const isMobile = window.innerWidth < 768;
            const spacing = isMobile ? 120 : gridSpacing;
            
            // Center the view on the current card position
            const centerOffsetX = window.innerWidth / 2;
            const centerOffsetY = window.innerHeight / 2;
            
            // Show all cards in grid positions
            grid.forEach((card, key) => {
                const [x, y] = key.split(',').map(Number);
                
                card.style.display = 'flex';
                card.classList.remove('center', 'side-left', 'side-right', 'side-top', 'side-bottom', 'off-screen');
                card.classList.add('grid-view');
                
                // Position card relative to current position
                const posX = centerOffsetX + (x - currentX) * spacing;
                const posY = centerOffsetY + (y - currentY) * spacing;
                
                card.style.left = posX + 'px';
                card.style.top = posY + 'px';
                
                // Add click handler to zoom back in on this card
                card.onclick = function(e) {
                    e.stopPropagation();
                    if (!hasDraggedDistance) {
                        currentX = x;
                        currentY = y;
                        toggleZoom();
                    }
                };
                
                // Add hover handlers for attributes panel update
                card.onmouseenter = function() {
                    updateAttributesPanel(x, y);
                };
                
                card.onmouseleave = function() {
                    // Restore panel to current focused card
                    updateAttributesPanel(currentX, currentY);
                };
            });
            
            // Initialize canvas offset
            canvasOffset = { x: 0, y: 0 };
        }

        // Drag functionality
        const canvasContainer = document.getElementById('canvasContainer');
        
        canvasContainer.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', endDrag);
        
        canvasContainer.addEventListener('touchstart', startDrag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('touchend', endDrag);

        function startDrag(e) {
            if (!isZoomedOut) return;
            
            isDragging = true;
            hasDraggedDistance = false;
            canvasContainer.classList.add('dragging');
            
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            
            dragStart = { x: clientX, y: clientY };
            dragOffset = { x: canvasOffset.x, y: canvasOffset.y };
            
            e.preventDefault();
        }

        function drag(e) {
            if (!isDragging || !isZoomedOut) return;
            
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            
            const deltaX = clientX - dragStart.x;
            const deltaY = clientY - dragStart.y;
            
            // Check if we've moved enough to consider it a drag
            if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
                hasDraggedDistance = true;
            }
            
            canvasOffset.x = dragOffset.x + deltaX;
            canvasOffset.y = dragOffset.y + deltaY;
            
            canvasContainer.style.transform = `translate(${canvasOffset.x}px, ${canvasOffset.y}px)`;
            
            e.preventDefault();
        }

        function endDrag(e) {
            if (!isDragging) return;
            
            // Small delay to prevent click events on cards
            setTimeout(() => {
                isDragging = false;
                canvasContainer.classList.remove('dragging');
            }, 10);
        }
    </script>
</body>
</html>